<script>
    /**
     * スライドショー管理アプリケーション
     */
    const adminApp = {
        // 設定情報
        config: {
            apiUrl: '',
            thresholds: [100, 200, 300],  // デフォルト値
            images: ['', '', '']          // デフォルト値
        },
        
        // 現在の状態
        state: {
            isLoading: false,
            selectedSlideIndex: -1
        },
        
        // DOM要素への参照
        elements: {},
        
        /**
         * アプリケーションの初期化
         */
        init() {
            console.log('管理アプリを初期化しています...');
            
            // DOM要素への参照を保存
            this.elements = {
                loader: document.getElementById('loader'),
                message: document.getElementById('message'),
                apiUrlInput: document.getElementById('api-url'),
                testConnectionBtn: document.getElementById('test-connection-btn'),
                thresholdsContainer: document.getElementById('thresholds-container'),
                addThresholdBtn: document.getElementById('add-threshold-btn'),
                imageGrid: document.getElementById('image-grid'),
                selectedSlideInfo: document.getElementById('selected-slide-info'),
                imageIdUrlInput: document.getElementById('image-id-url-input'),
                imageUploadInput: document.getElementById('image-upload-input'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                homeBtn: document.getElementById('home-btn'),
                tabs: document.querySelectorAll('.tab'),
                tabPanes: document.querySelectorAll('.tab-pane')
            };
            
            // イベントリスナーの設定
            this.setupEventListeners();
            
            // APIのURLをローカルストレージから読み込む
            this.config.apiUrl = localStorage.getItem('slideAppApiUrl') || '';
            this.elements.apiUrlInput.value = this.config.apiUrl;
            
            // 設定情報の読み込み
            if (this.config.apiUrl) {
                this.loadConfig();
            }
            
            // UIの初期化
            this.renderThresholds();
            this.renderImageGrid();
        },
        
        /**
         * イベントリスナーの設定
         */
        setupEventListeners() {
            // タブ切り替え
            this.elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    this.switchTab(tab.dataset.tab);
                });
            });
            
            // 接続テスト
            this.elements.testConnectionBtn.addEventListener('click', () => {
                this.testConnection();
            });
            
            // 閾値追加
            this.elements.addThresholdBtn.addEventListener('click', () => {
                this.addThreshold();
            });
            
            // 設定保存
            this.elements.saveSettingsBtn.addEventListener('click', () => {
                this.saveAllSettings();
            });
            
            // メイン画面へ戻る
            this.elements.homeBtn.addEventListener('click', () => {
                window.location.href = 'index.html';
            });
            
            // 画像アップロード
            this.elements.imageUploadInput.addEventListener('change', (event) => {
                if (this.state.selectedSlideIndex >= 0 && event.target.files.length > 0) {
                    this.handleImageUpload(event.target.files[0]);
                }
            });
            
            // 画像URLの更新
            this.elements.imageIdUrlInput.addEventListener('change', (event) => {
                if (this.state.selectedSlideIndex >= 0) {
                    this.config.images[this.state.selectedSlideIndex] = event.target.value.trim();
                    this.renderImageGrid();
                }
            });
        },
        
        /**
         * A-01: タブ切り替え
         */
        switchTab(tabId) {
            this.elements.tabs.forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });
            
            this.elements.tabPanes.forEach(pane => {
                pane.classList.toggle('active', pane.id === tabId);
            });
        },
        
        /**
         * A-03: 設定情報の読み込み
         */
        async loadConfig() {
            this.showLoading(true);
            try {
                const response = await fetch(`${this.config.apiUrl}?action=getConfig`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    // 設定データを更新
                    this.config.thresholds = data.thresholds || this.config.thresholds;
                    this.config.images = data.images || this.config.images;
                    
                    // 足りない配列要素を初期化
                    while (this.config.images.length < this.config.thresholds.length) {
                        this.config.images.push('');
                    }
                    
                    console.log('設定を読み込みました:', this.config);
                    this.showMessage('設定を読み込みました', 'success');
                    
                    // UIを更新
                    this.renderThresholds();
                    this.renderImageGrid();
                } else {
                    throw new Error(data.message || '設定の読み込みに失敗しました');
                }
            } catch (error) {
                console.error('設定読み込みエラー:', error);
                this.showMessage(`設定の読み込みに失敗しました: ${error.message}`, 'error');
            } finally {
                this.showLoading(false);
            }
        },
        
        /**
         * A-04: スライド閾値設定のレンダリング
         */
        renderThresholds() {
            this.elements.thresholdsContainer.innerHTML = '';
            
            this.config.thresholds.forEach((threshold, index) => {
                const thresholdItem = document.createElement('div');
                thresholdItem.className = 'threshold-item';
                
                thresholdItem.innerHTML = `
                    <div class="threshold-header">
                        <span>スライド ${index + 1}</span>
                        <button class="btn danger remove-threshold" data-index="${index}">削除</button>
                    </div>
                    <div class="form-group">
                        <label for="threshold-${index}">表示閾値:</label>
                        <input type="number" id="threshold-${index}" class="slide-threshold" 
                            data-index="${index}" value="${threshold}" min="0">
                        <p class="help-text">合計値がこの値以上になると、スライド${index + 1}が表示されます。</p>
                    </div>
                `;
                
                this.elements.thresholdsContainer.appendChild(thresholdItem);
            });
            
            // 削除ボタンのイベントリスナー
            document.querySelectorAll('.remove-threshold').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    this.removeThreshold(index);
                });
            });
            
            // 値変更のイベントリスナー
            document.querySelectorAll('.slide-threshold').forEach(input => {
                input.addEventListener('change', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    this.config.thresholds[index] = parseInt(event.target.value) || 0;
                });
            });
        },
        
        /**
         * 閾値の追加
         */
        addThreshold() {
            // 最後の閾値より大きい値をデフォルト値とする
            const lastThreshold = this.config.thresholds.length > 0 
                ? this.config.thresholds[this.config.thresholds.length - 1] 
                : 0;
                
            this.config.thresholds.push(lastThreshold + 100);
            this.config.images.push('');
            
            this.renderThresholds();
            this.renderImageGrid();
            
            this.showMessage('新しい閾値を追加しました', 'success');
        },
        
        /**
         * 閾値の削除
         */
        removeThreshold(index) {
            if (index >= 0 && index < this.config.thresholds.length) {
                this.config.thresholds.splice(index, 1);
                this.config.images.splice(index, 1);
                
                this.renderThresholds();
                this.renderImageGrid();
                
                // 選択中のスライドが削除された場合、選択をクリア
                if (this.state.selectedSlideIndex === index) {
                    this.selectSlide(-1);
                } else if (this.state.selectedSlideIndex > index) {
                    // 選択中のスライドのインデックスを調整
                    this.selectSlide(this.state.selectedSlideIndex - 1);
                }
                
                this.showMessage('閾値を削除しました', 'success');
            }
        },
        
        /**
         * A-07: 現在の画像設定表示
         */
        renderImageGrid() {
            this.elements.imageGrid.innerHTML = '';
            
            this.config.thresholds.forEach((threshold, index) => {
                const imageUrl = this.getImageUrl(this.config.images[index]);
                
                const gridItem = document.createElement('div');
                gridItem.className = 'image-grid-item';
                gridItem.dataset.index = index;
                if (index === this.state.selectedSlideIndex) {
                    gridItem.classList.add('selected');
                }
                
                gridItem.innerHTML = `
                    <div class="image-preview ${!imageUrl ? 'empty' : ''}">
                        ${imageUrl 
                            ? `<img src="${imageUrl}" alt="スライド ${index + 1}" onerror="this.parentNode.innerHTML='<div class=\\'no-image\\'>画像読み込みエラー</div>'">` 
                            : '<div class="no-image">画像未設定</div>'}
                    </div>
                    <div class="image-info">
                        <span>スライド ${index + 1}</span>
                        <span>閾値: ${threshold}</span>
                    </div>
                `;
                
                this.elements.imageGrid.appendChild(gridItem);
            });
            
            // 画像選択のイベントリスナー
            document.querySelectorAll('.image-grid-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    this.selectSlide(index);
                });
            });
        },
        
        /**
         * スライドを選択して詳細表示を更新
         */
        selectSlide(index) {
            this.state.selectedSlideIndex = index;
            
            // 選択状態のクラスを更新
            document.querySelectorAll('.image-grid-item').forEach(item => {
                const itemIndex = parseInt(item.dataset.index);
                item.classList.toggle('selected', itemIndex === index);
            });
            
            // 選択情報の表示を更新
            if (index >= 0 && index < this.config.thresholds.length) {
                this.elements.selectedSlideInfo.textContent = `スライド ${index + 1} を編集中 (閾値: ${this.config.thresholds[index]})`;
                this.elements.imageIdUrlInput.value = this.config.images[index] || '';
                this.elements.imageIdUrlInput.disabled = false;
                this.elements.imageUploadInput.disabled = false;
            } else {
                this.elements.selectedSlideInfo.textContent = 'スライドを選択してください';
                this.elements.imageIdUrlInput.value = '';
                this.elements.imageIdUrlInput.disabled = true;
                this.elements.imageUploadInput.disabled = true;
            }
        },
        
        /**
         * 画像URLを生成
         */
        getImageUrl(imageIdOrUrl) {
            if (!imageIdOrUrl) return '';
            
            // すでにURLの場合はそのまま返す
            if (imageIdOrUrl.startsWith('http://') || imageIdOrUrl.startsWith('https://')) {
                return imageIdOrUrl;
            }
            
            // Google DriveのファイルIDの場合、表示用URLを生成
            return `https://drive.google.com/uc?export=view&id=${imageIdOrUrl}`;
        },
        
        /**
         * A-06: 画像アップロード処理
         */
        async handleImageUpload(file) {
            if (this.state.selectedSlideIndex < 0) {
                this.showMessage('先にスライドを選択してください', 'error');
                return;
            }
            
            // 対応フォーマットの確認
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                this.showMessage('対応していない画像形式です。JPEG, PNG, GIFのみアップロード可能です。', 'error');
                return;
            }
            
            this.showLoading(true);
            
            try {
                // ファイルをBase64エンコード
                const base64Data = await this.readFileAsBase64(file);
                
                // サーバーにアップロード
                const response = await fetch(`${this.config.apiUrl}?action=uploadImage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: base64Data,
                        fileName: file.name
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // アップロードに成功したら、画像IDを保存
                    this.config.images[this.state.selectedSlideIndex] = data.imageId;
                    this.elements.imageIdUrlInput.value = data.imageId;
                    
                    // 画像グリッドを更新
                    this.renderImageGrid();
                    
                    this.showMessage('画像がアップロードされました', 'success');
                } else {
                    throw new Error(data.message || 'アップロードに失敗しました');
                }
            } catch (error) {
                console.error('画像アップロードエラー:', error);
                this.showMessage(`画像のアップロードに失敗しました: ${error.message}`, 'error');
            } finally {
                // ファイル選択をリセット
                this.elements.imageUploadInput.value = '';
                this.showLoading(false);
            }
        },
        
        /**
         * ファイルをBase64エンコードされた文字列として読み込む
         */
        readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    resolve(event.target.result);
                };
                
                reader.onerror = (error) => {
                    reject(error);
                };
                
                reader.readAsDataURL(file);
            });
        },
        
        /**
         * A-09: 接続テスト
         */
        async testConnection() {
            const apiUrl = this.elements.apiUrlInput.value.trim();
            
            if (!apiUrl) {
                this.showMessage('API URLを入力してください', 'error');
                return;
            }
            
            this.showLoading(true);
            
            try {
                const response = await fetch(`${apiUrl}?action=test`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    this.showMessage(`接続テスト成功！ サーバー時刻: ${data.timestamp}`, 'success');
                    
                    // 成功したらAPIのURLを保存
                    this.config.apiUrl = apiUrl;
                    localStorage.setItem('slideAppApiUrl', apiUrl);
                } else {
                    throw new Error(data.message || '接続テストに失敗しました');
                }
            } catch (error) {
                console.error('接続テストエラー:', error);
                this.showMessage(`接続テストに失敗しました: ${error.message}`, 'error');
            } finally {
                this.showLoading(false);
            }
        },
        
        /**
         * A-08: すべての設定を保存
         */
        async saveAllSettings() {
            // API URLをチェック
            const apiUrl = this.elements.apiUrlInput.value.trim();
            if (!apiUrl) {
                this.showMessage('API URLを入力してください', 'error');
                return;
            }
            
            // ローカルストレージにAPI URLを保存
            localStorage.setItem('slideAppApiUrl', apiUrl);
            this.config.apiUrl = apiUrl;
            
            this.showLoading(true);
            
            try {
                // 設定をサーバーに保存
                const response = await fetch(`${this.config.apiUrl}?action=saveConfig`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        thresholds: this.config.thresholds,
                        images: this.config.images
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    this.showMessage('すべての設定が保存されました', 'success');
                } else {
                    throw new Error(data.message || '設定の保存に失敗しました');
                }
            } catch (error) {
                console.error('設定保存エラー:', error);
                this.showMessage(`設定の保存に失敗しました: ${error.message}`, 'error');
            } finally {
                this.showLoading(false);
            }
        },
        
        /**
         * A-11: ローディング表示
         */
        showLoading(show) {
            this.state.isLoading = show;
            this.elements.loader.classList.toggle('hidden', !show);
        },
        
        /**
         * A-11: メッセージ表示
         */
        showMessage(message, type = 'success') {
            console.log(`メッセージ (${type}):`, message);
            
            this.elements.message.textContent = message;
            this.elements.message.className = type;
            this.elements.message.classList.remove('hidden');
            
            // 5秒後にメッセージを非表示にする
            setTimeout(() => {
                this.elements.message.classList.add('hidden');
            }, 5000);
        }
    };

    // アプリケーションの初期化
    document.addEventListener('DOMContentLoaded', () => {
        adminApp.init();
    });
</script>
