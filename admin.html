<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スライドショー管理画面</title>
    <link rel="stylesheet" href="admin.css">
    <!-- デバッグモードをオンに -->
    <script>
        // デバッグ機能
        const DEBUG = true;
        function debug(...args) {
            if (DEBUG) {
                console.log('[DEBUG]', ...args);
            }
        }
    </script>
</head>
<body>
    <div id="admin-app">
        <header>
            <h1>スライドショー管理画面</h1>
            <!-- A-10: メイン画面へ戻る -->
            <button id="home-btn" class="btn">メイン画面へ戻る</button>
        </header>
        
        <!-- A-11: UIフィードバック -->
        <div id="loader" class="hidden">処理中...</div>
        <div id="message" class="hidden"></div>
        
        <!-- A-01: UI構成 - タブナビゲーション -->
        <div class="tabs">
            <button class="tab active" data-tab="basic-settings">基本設定</button>
            <button class="tab" data-tab="slide-settings">スライド設定</button>
            <button class="tab" data-tab="image-settings">画像設定</button>
        </div>
        
        <div class="tab-content">
            <!-- 基本設定タブ -->
            <div id="basic-settings" class="tab-pane active">
                <h2>基本設定</h2>
                
                <!-- A-02: API URL設定 -->
                <div class="form-group">
                    <label for="api-url">Google Apps Script WebアプリURL:</label>
                    <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/...">
                    <p class="help-text">Google Apps ScriptをWebアプリとしてデプロイした際のURLを入力してください。</p>
                </div>
                
                <!-- A-09: 接続テスト -->
                <div class="form-group">
                    <button id="test-connection-btn" class="btn">接続テスト</button>
                </div>
            </div>
            
            <!-- スライド設定タブ -->
            <div id="slide-settings" class="tab-pane">
                <h2>スライド閾値設定</h2>
                <p>各スライドを表示するために必要な「Google Form回答の合計値」の閾値を設定します。</p>
                
                <!-- A-04: スライド閾値設定 -->
                <div id="thresholds-container">
                    <!-- JavaScript で動的に生成 -->
                </div>
                
                <button id="add-threshold-btn" class="btn">閾値を追加</button>
            </div>
            
            <!-- 画像設定タブ -->
            <div id="image-settings" class="tab-pane">
                <h2>スライド画像設定</h2>
                
                <!-- A-07: 現在の画像設定表示 -->
                <div id="image-grid">
                    <!-- JavaScript で動的に生成 -->
                </div>
                
                <!-- A-05, A-06: 画像設定 (URL/ID, アップロード) -->
                <div class="image-upload-section">
                    <h3>選択中スライドの画像設定</h3>
                    <div id="selected-slide-info">スライドを選択してください</div>
                    
                    <div class="form-group">
                        <label for="image-id-url-input">画像URLまたはGoogle DriveファイルID:</label>
                        <input type="text" id="image-id-url-input" placeholder="https://... または DriveファイルID">
                    </div>
                    
                    <div class="form-group">
                        <label for="image-upload-input">または、画像をアップロード:</label>
                        <input type="file" id="image-upload-input" accept="image/*">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- A-08: 設定の保存 -->
        <div class="form-actions">
            <button id="save-settings-btn" class="btn primary">すべての設定を保存</button>
        </div>
    </div>
    
    <script>
        /**
         * スライドショー管理アプリケーション
         */
        document.addEventListener('DOMContentLoaded', function() {
            debug('DOM完全に読み込まれました');
            
            const adminApp = {
                // 設定情報
                config: {
                    apiUrl: '',
                    thresholds: [100, 200, 300],  // デフォルト値
                    images: ['', '', '']          // デフォルト値
                },
                
                // 現在の状態
                state: {
                    isLoading: false,
                    selectedSlideIndex: -1
                },
                
                // DOM要素への参照
                elements: {},
                
                /**
                 * アプリケーションの初期化
                 */
                init() {
                    debug('管理アプリを初期化しています...');
                    
                    // DOM要素への参照を保存
                    this.cacheElements();
                    
                    // イベントリスナーの設定
                    this.setupEventListeners();
                    
                    // APIのURLをローカルストレージから読み込む
                    try {
                        this.config.apiUrl = localStorage.getItem('slideAppApiUrl') || '';
                        debug('ローカルストレージからAPIのURL読み込み:', this.config.apiUrl);
                        this.elements.apiUrlInput.value = this.config.apiUrl;
                    } catch (error) {
                        console.error('ローカルストレージアクセスエラー:', error);
                        this.showMessage('ローカルストレージへのアクセスに失敗しました。ブラウザの設定を確認してください。', 'error');
                    }
                    
                    // 設定情報の読み込み
                    if (this.config.apiUrl) {
                        this.loadConfig();
                    } else {
                        debug('APIのURLが設定されていないため、デフォルト設定を使用します');
                    }
                    
                    // UIの初期化
                    this.renderThresholds();
                    this.renderImageGrid();
                },
                
                /**
                 * DOM要素の参照をキャッシュ
                 */
                cacheElements() {
                    try {
                        this.elements = {
                            loader: document.getElementById('loader'),
                            message: document.getElementById('message'),
                            apiUrlInput: document.getElementById('api-url'),
                            testConnectionBtn: document.getElementById('test-connection-btn'),
                            thresholdsContainer: document.getElementById('thresholds-container'),
                            addThresholdBtn: document.getElementById('add-threshold-btn'),
                            imageGrid: document.getElementById('image-grid'),
                            selectedSlideInfo: document.getElementById('selected-slide-info'),
                            imageIdUrlInput: document.getElementById('image-id-url-input'),
                            imageUploadInput: document.getElementById('image-upload-input'),
                            saveSettingsBtn: document.getElementById('save-settings-btn'),
                            homeBtn: document.getElementById('home-btn'),
                            tabs: document.querySelectorAll('.tab'),
                            tabPanes: document.querySelectorAll('.tab-pane')
                        };
                        
                        // DOM要素の存在確認
                        for (const [key, element] of Object.entries(this.elements)) {
                            if (!element && !Array.isArray(element)) {
                                console.warn(`DOM要素が見つかりません: ${key}`);
                            } else if (Array.isArray(element) && element.length === 0) {
                                console.warn(`DOM要素が見つかりません（空の配列）: ${key}`);
                            }
                        }
                    } catch (error) {
                        console.error('DOM要素キャッシュエラー:', error);
                    }
                },
                
                /**
                 * イベントリスナーの設定
                 */
                setupEventListeners() {
                    try {
                        // タブ切り替え
                        this.elements.tabs.forEach(tab => {
                            debug('タブにイベントリスナーを設定:', tab.dataset.tab);
                            tab.addEventListener('click', (e) => {
                                e.preventDefault();
                                debug('タブがクリックされました:', tab.dataset.tab);
                                this.switchTab(tab.dataset.tab);
                            });
                        });
                        
                        // 接続テスト
                        if (this.elements.testConnectionBtn) {
                            debug('接続テストボタンにイベントリスナーを設定');
                            this.elements.testConnectionBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                debug('接続テストボタンがクリックされました');
                                this.testConnection();
                            });
                        }
                        
                        // 閾値追加
                        if (this.elements.addThresholdBtn) {
                            debug('閾値追加ボタンにイベントリスナーを設定');
                            this.elements.addThresholdBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                debug('閾値追加ボタンがクリックされました');
                                this.addThreshold();
                            });
                        }
                        
                        // 設定保存
                        if (this.elements.saveSettingsBtn) {
                            debug('設定保存ボタンにイベントリスナーを設定');
                            this.elements.saveSettingsBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                debug('設定保存ボタンがクリックされました');
                                this.saveAllSettings();
                            });
                        }
                        
                        // メイン画面へ戻る
                        if (this.elements.homeBtn) {
                            debug('ホームボタンにイベントリスナーを設定');
                            this.elements.homeBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                debug('ホームボタンがクリックされました');
                                window.location.href = 'index.html';
                            });
                        }
                        
                        // 画像アップロード
                        if (this.elements.imageUploadInput) {
                            debug('画像アップロード入力にイベントリスナーを設定');
                            this.elements.imageUploadInput.addEventListener('change', (event) => {
                                debug('画像アップロード入力が変更されました');
                                if (this.state.selectedSlideIndex >= 0 && event.target.files.length > 0) {
                                    this.handleImageUpload(event.target.files[0]);
                                } else {
                                    debug('スライドが選択されていないか、ファイルが選択されていません');
                                }
                            });
                        }
                        
                        // 画像URLの更新
                        if (this.elements.imageIdUrlInput) {
                            debug('画像URL入力にイベントリスナーを設定');
                            this.elements.imageIdUrlInput.addEventListener('change', (event) => {
                                debug('画像URL入力が変更されました');
                                if (this.state.selectedSlideIndex >= 0) {
                                    this.config.images[this.state.selectedSlideIndex] = event.target.value.trim();
                                    this.renderImageGrid();
                                } else {
                                    debug('スライドが選択されていません');
                                }
                            });
                        }
                        
                        debug('すべてのイベントリスナーが設定されました');
                    } catch (error) {
                        console.error('イベントリスナー設定エラー:', error);
                    }
                },
                
                /**
                 * A-01: タブ切り替え
                 */
                switchTab(tabId) {
                    try {
                        debug('タブを切り替えます:', tabId);
                        
                        this.elements.tabs.forEach(tab => {
                            tab.classList.toggle('active', tab.dataset.tab === tabId);
                            debug(`タブ ${tab.dataset.tab} アクティブ状態:`, tab.classList.contains('active'));
                        });
                        
                        this.elements.tabPanes.forEach(pane => {
                            pane.classList.toggle('active', pane.id === tabId);
                            debug(`ペイン ${pane.id} アクティブ状態:`, pane.classList.contains('active'));
                        });
                    } catch (error) {
                        console.error('タブ切り替えエラー:', error);
                    }
                },
                
                /**
                 * A-03: 設定情報の読み込み
                 */
                async loadConfig() {
                    this.showLoading(true);
                    debug('設定情報の読み込みを開始...');
                    
                    try {
                        if (!this.config.apiUrl) {
                            throw new Error('API URLが設定されていません');
                        }
                        
                        const response = await fetch(`${this.config.apiUrl}?action=getConfig`);
                        debug('API応答ステータス:', response.status);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP エラー! ステータス: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        debug('取得したデータ:', data);
                        
                        if (data.success) {
                            // 設定データを更新
                            this.config.thresholds = data.thresholds || this.config.thresholds;
                            this.config.images = data.images || this.config.images;
                            
                            // 足りない配列要素を初期化
                            while (this.config.images.length < this.config.thresholds.length) {
                                this.config.images.push('');
                            }
                            
                            debug('設定を読み込みました:', this.config);
                            this.showMessage('設定を読み込みました', 'success');
                            
                            // UIを更新
                            this.renderThresholds();
                            this.renderImageGrid();
                        } else {
                            throw new Error(data.message || '設定の読み込みに失敗しました');
                        }
                    } catch (error) {
                        console.error('設定読み込みエラー:', error);
                        this.showMessage(`設定の読み込みに失敗しました: ${error.message}`, 'error');
                    } finally {
                        this.showLoading(false);
                    }
                },
                
                /**
                 * A-04: スライド閾値設定のレンダリング
                 */
                renderThresholds() {
                    try {
                        debug('閾値設定の描画を開始...');
                        
                        if (!this.elements.thresholdsContainer) {
                            console.error('thresholdsContainer要素が見つかりません');
                            return;
                        }
                        
                        this.elements.thresholdsContainer.innerHTML = '';
                        
                        this.config.thresholds.forEach((threshold, index) => {
                            debug(`閾値項目を描画: インデックス=${index}, 値=${threshold}`);
                            
                            const thresholdItem = document.createElement('div');
                            thresholdItem.className = 'threshold-item';
                            
                            thresholdItem.innerHTML = `
                                <div class="threshold-header">
                                    <span>スライド ${index + 1}</span>
                                    <button class="btn danger remove-threshold" data-index="${index}">削除</button>
                                </div>
                                <div class="form-group">
                                    <label for="threshold-${index}">表示閾値:</label>
                                    <input type="number" id="threshold-${index}" class="slide-threshold" 
                                        data-index="${index}" value="${threshold}" min="0">
                                    <p class="help-text">合計値がこの値以上になると、スライド${index + 1}が表示されます。</p>
                                </div>
                            `;
                            
                            this.elements.thresholdsContainer.appendChild(thresholdItem);
                        });
                        
                        // 削除ボタンのイベントリスナー
                        document.querySelectorAll('.remove-threshold').forEach(button => {
                            debug(`削除ボタンにイベントリスナーを設定: インデックス=${button.dataset.index}`);
                            
                            // 既存のイベントリスナーを削除（イベントの重複を防ぐ）
                            button.removeEventListener('click', this._handleThresholdRemoveClick);
                            
                            // 新しいイベントリスナーを設定
                            this._handleThresholdRemoveClick = (event) => {
                                const index = parseInt(event.target.dataset.index);
                                debug(`削除ボタンがクリックされました: インデックス=${index}`);
                                this.removeThreshold(index);
                            };
                            
                            button.addEventListener('click', this._handleThresholdRemoveClick);
                        });
                        
                        // 値変更のイベントリスナー
                        document.querySelectorAll('.slide-threshold').forEach(input => {
                            debug(`閾値入力にイベントリスナーを設定: インデックス=${input.dataset.index}`);
                            
                            // 既存のイベントリスナーを削除（イベントの重複を防ぐ）
                            input.removeEventListener('change', this._handleThresholdChange);
                            
                            // 新しいイベントリスナーを設定
                            this._handleThresholdChange = (event) => {
                                const index = parseInt(event.target.dataset.index);
                                const value = parseInt(event.target.value) || 0;
                                debug(`閾値が変更されました: インデックス=${index}, 新しい値=${value}`);
                                this.config.thresholds[index] = value;
                            };
                            
                            input.addEventListener('change', this._handleThresholdChange);
                        });
                        
                        debug('閾値設定の描画が完了しました');
                    } catch (error) {
                        console.error('閾値描画エラー:', error);
                    }
                },
                
                /**
                 * 閾値の追加
                 */
                addThreshold() {
                    try {
                        debug('閾値を追加します');
                        
                        // 最後の閾値より大きい値をデフォルト値とする
                        const lastThreshold = this.config.thresholds.length > 0 
                            ? this.config.thresholds[this.config.thresholds.length - 1] 
                            : 0;
                            
                        this.config.thresholds.push(lastThreshold + 100);
                        this.config.images.push('');
                        
                        debug('閾値を追加しました:', this.config.thresholds);
                        
                        this.renderThresholds();
                        this.renderImageGrid();
                        
                        this.showMessage('新しい閾値を追加しました', 'success');
                    } catch (error) {
                        console.error('閾値追加エラー:', error);
                        this.showMessage('閾値の追加に失敗しました', 'error');
                    }
                },
                
                /**
                 * 閾値の削除
                 */
                removeThreshold(index) {
                    try {
                        debug(`閾値を削除します: インデックス=${index}`);
                        
                        if (index >= 0 && index < this.config.thresholds.length) {
                            this.config.thresholds.splice(index, 1);
                            this.config.images.splice(index, 1);
                            
                            debug('閾値を削除しました:', this.config.thresholds);
                            
                            this.renderThresholds();
                            this.renderImageGrid();
                            
                            // 選択中のスライドが削除された場合、選択をクリア
                            if (this.state.selectedSlideIndex === index) {
                                this.selectSlide(-1);
                            } else if (this.state.selectedSlideIndex > index) {
                                // 選択中のスライドのインデックスを調整
                                this.selectSlide(this.state.selectedSlideIndex - 1);
                            }
                            
                            this.showMessage('閾値を削除しました', 'success');
                        } else {
                            debug(`無効なインデックス: ${index}`);
                        }
                    } catch (error) {
                        console.error('閾値削除エラー:', error);
                        this.showMessage('閾値の削除に失敗しました', 'error');
                    }
                },
                
                /**
                 * A-07: 現在の画像設定表示
                 */
                renderImageGrid() {
                    try {
                        debug('画像グリッドの描画を開始...');
                        
                        if (!this.elements.imageGrid) {
                            console.error('imageGrid要素が見つかりません');
                            return;
                        }
                        
                        this.elements.imageGrid.innerHTML = '';
                        
                        this.config.thresholds.forEach((threshold, index) => {
                            debug(`画像グリッド項目を描画: インデックス=${index}, 閾値=${threshold}`);
                            
                            const imageUrl = this.getImageUrl(this.config.images[index]);
                            debug(`画像URL: ${imageUrl}`);
                            
                            const gridItem = document.createElement('div');
                            gridItem.className = 'image-grid-item';
                            gridItem.dataset.index = index;
                            if (index === this.state.selectedSlideIndex) {
                                gridItem.classList.add('selected');
                            }
                            
                            // エラー処理のためのエスケープ処理を強化
                            const noImageHtml = '<div class="no-image">画像未設定</div>';
                            const imgHtml = imageUrl 
                                ? `<img src="${imageUrl}" alt="スライド ${index + 1}" onerror="this.parentNode.innerHTML='<div class=\\'no-image\\'>画像読み込みエラー</div>'">`
                                : noImageHtml;
                            
                            gridItem.innerHTML = `
                                <div class="image-preview ${!imageUrl ? 'empty' : ''}">
                                    ${imgHtml}
                                </div>
                                <div class="image-info">
                                    <span>スライド ${index + 1}</span>
                                    <span>閾値: ${threshold}</span>
                                </div>
                            `;
                            
                            this.elements.imageGrid.appendChild(gridItem);
                        });
                        
                        // 画像選択のイベントリスナー
                        document.querySelectorAll('.image-grid-item').forEach(item => {
                            const itemIndex = parseInt(item.dataset.index);
                            debug(`画像グリッド項目にイベントリスナーを設定: インデックス=${itemIndex}`);
                            
                            // 既存のイベントリスナーを削除（イベントの重複を防ぐ）
                            item.removeEventListener('click', this._handleImageItemClick);
                            
                            // 新しいイベントリスナーを設定
                            this._handleImageItemClick = (event) => {
                                const index = parseInt(event.currentTarget.dataset.index);
                                debug(`画像グリッド項目がクリックされました: インデックス=${index}`);
                                this.selectSlide(index);
                            };
                            
                            item.addEventListener('click', this._handleImageItemClick);
                        });
                        
                        debug('画像グリッドの描画が完了しました');
                    } catch (error) {
                        console.error('画像グリッド描画エラー:', error);
                    }
                },
                
                /**
                 * スライドを選択して詳細表示を更新
                 */
                selectSlide(index) {
                    try {
                        debug(`スライドを選択: インデックス=${index}`);
                        
                        this.state.selectedSlideIndex = index;
                        
                        // 選択状態のクラスを更新
                        document.querySelectorAll('.image-grid-item').forEach(item => {
                            const itemIndex = parseInt(item.dataset.index);
                            item.classList.toggle('selected', itemIndex === index);
                            debug(`画像グリッド項目 ${itemIndex} 選択状態:`, item.classList.contains('selected'));
                        });
                        
                        // 選択情報の表示を更新
                        if (index >= 0 && index < this.config.thresholds.length) {
                            this.elements.selectedSlideInfo.textContent = `スライド ${index + 1} を編集中 (閾値: ${this.config.thresholds[index]})`;
                            this.elements.imageIdUrlInput.value = this.config.images[index] || '';
                            this.elements.imageIdUrlInput.disabled = false;
                            this.elements.imageUploadInput.disabled = false;
                            
                            debug('スライド選択情報を更新しました');
                        } else {
                            this.elements.selectedSlideInfo.textContent = 'スライドを選択してください';
                            this.elements.imageIdUrlInput.value = '';
                            this.elements.imageIdUrlInput.disabled = true;
                            this.elements.imageUploadInput.disabled = true;
                            
                            debug('スライド選択をクリアしました');
                        }
                    } catch (error) {
                        console.error('スライド選択エラー:', error);
                    }
                },
                
                /**
                 * 画像URLを生成
                 */
                getImageUrl(imageIdOrUrl) {
                    try {
                        if (!imageIdOrUrl) return '';
                        
                        // すでにURLの場合はそのまま返す
                        if (imageIdOrUrl.startsWith('http://') || imageIdOrUrl.startsWith('https://')) {
                            return imageIdOrUrl;
                        }
                        
                        // Google DriveのファイルIDの場合、表示用URLを生成
                        return `https://drive.google.com/uc?export=view&id=${imageIdOrUrl}`;
                    } catch (error) {
                        console.error('画像URL生成エラー:', error);
